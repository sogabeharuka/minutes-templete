<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>議事録テンプレート生成</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/micromodal/0.4.10/micromodal.min.js"></script>
  </head>
  <body>
    <header>
      <div class="container">
        <h2 class="ttl">議事録テンプレート生成</h2>
        <div class="point">
          <p>*は必須項目です</p>
        </div>
        <div class="div">
          <label class="label">施策名<span style="color: #da3c41">*</span></label>
          <div class="cp_ipselect">
            <select id="policyName" class="cp_sl02" required>
              <option selected disabled>選択してください</option>
              <option value="devCamp">devCamp</option>
              <option value="kintone hack">kintone hack</option>
              <option value="ヒアリングプロジェクト">ヒアリングプロジェクト</option>
              <option value="kintone Dojo">kintone Dojo</option>
            </select>
          </div>
        </div>
        <div class="text">
          <label for="title" class="label">タイトル<span style="color: #da3c41">*</span></label>
          <div><input type="text" id="title" required /></div>
        </div>
        <div class="div">
          <label for="person" class="label"
            >担当・報告者<span style="color: #da3c41">*</span></label
          >
          <div>
            <div class="checkBox">
              <input type="checkbox" id="personInChargeTeru" class="personInCharge" required />
              <label for="personInChargeTeru">Teru</label>
            </div>
            <div class="checkBox">
              <input type="checkbox" id="personInCharge53" class="personInCharge" required />
              <label for="personInCharge53">53</label>
            </div>
            <div class="checkBox">
              <input type="checkbox" id="personInChargeShinShin" class="personInCharge" required />
              <label for="personInChargeShinShin">しんしん</label>
            </div>
            <div class="checkBox">
              <input type="checkbox" id="personInChargeIwakun" class="personInCharge" required />
              <label for="personInChargeIwakun">いわくん</label>
            </div>
            <div class="checkBox">
              <input type="checkbox" id="personInChargeYukatan" class="personInCharge" required />
              <label for="personInChargeYukatan">ユカタン</label>
            </div>
            <div class="checkBox">
              <input type="checkbox" id="personInChargeGabe" class="personInCharge" required />
              <label for="personInChargeGabe">がべ</label>
            </div>
            <div class="checkBox">
              <input type="checkbox" id="personInChargeKo" class="personInCharge" required />
              <label for="personInChargeKo">ko</label>
            </div>
            <div class="checkBox">
              <input type="checkbox" id="personInChargeSari" class="personInCharge" required />
              <label for="personInChargeSari">サーリー</label>
            </div>
            <div class="checkBox">
              <input type="checkbox" id="personInChargeHao" class="personInCharge" required />
              <label for="personInChargeHao">HAO</label>
            </div>
          </div>
        </div>
        <div class="text">
          <div><label for="status" class="label">ステータス</label></div>
          <input type="text" id="status" required />
        </div>
        <div class="point">
          <p>↓開催日・日付はどちらか一方を入力してください</p>
        </div>
        <div class="dateDiv">
          <div class="dateSelect">
            <label for="date" class="datelabel">開催日</label>
            <input type="date" id="date" required />
          </div>
          <div class="dateSelect">
            <div><label for="term" class="datelabel">期間</label></div>
            <div class="dateText">
              <input type="date" id="term" required />
              <span>まで</span>
            </div>
          </div>
        </div>
        <div class="div">
          <div>
            <label for="report" class="label"
              >報告・相談<span style="color: #da3c41">*</span></label
            >
          </div>
          <textarea
            id="report"
            class="textarea"
            placeholder="マークダウン形式で記入してください"
          ></textarea>
        </div>
        <div class="div">
          <div><label for="nextAction" class="label">Next Action</label></div>
          <textarea
            id="nextAction"
            class="textarea"
            placeholder="マークダウン形式で記入してください"
          ></textarea>
        </div>
        <div class="div">
          <button data-micromodal-trigger="modal-1" role="button" id="button" class="btn-square">
            生成する
          </button>
        </div>
      </div>
    </header>
    <script>
      // フォーマット作成
      const createFormat = () => {
        // 最新情報を反映するために、modalが既に存在していたら削除
        const existingModal = document.getElementById('modal-1');
        if (existingModal) {
          existingModal.remove();
        }

        const policyName = document.getElementById('policyName').value;
        const title = document.getElementById('title').value;

        // 担当者・報告者を入れる箱
        let personInCharge = [];
        // 人名全てを取得
        const personCheck = document.querySelectorAll('.personInCharge');

        personCheck.forEach((person) => {
          // チェックされていたら名前取得
          if (person.checked) {
            const personName = document.querySelector(`label[for="${person.id}"]`).textContent;
            personInCharge.push(personName);
          }
        });
        const personString = personInCharge.join('\n- ');
        const status = document.getElementById('status').value;
        const date = document.getElementById('date').value;
        const term = document.getElementById('term').value;
        const report = document.getElementById('report').value;
        const nextAction = document.getElementById('nextAction').value;

        const format = `
### ${policyName}

#### ◼︎ ${title}

##### 担当・報告者\n\n- ${personString}

${status ? `##### ステータス\n\n- ${status}` : ''}

${date ? `##### 開催日\n\n- ${date}` : ''}

${term ? `##### 期間\n\n- ${term}まで` : ''}

##### 報告・相談

${report}

${nextAction ? `##### Next Action\n\n${nextAction}` : ''}`;
        // 2行以上の空行を1行に統一
        const replacedFormat = format.replace(/\r?\n{3,}/, '\n\n');

        // モーダルをHTMLに入れる
        const modalHTML = `
                                <div class="modal micromodal-slide" id="modal-1" aria-hidden="true">
                                  <div class="modal-overlay" tabindex="-1" data-micromodal-close>
                                    <div class="modal-container" role="dialog" aria-modal="true" aria-labelledby="modal-1-title">
                                       <header class="modal-header">
                                         <h2 class="modal-title" id="modal-1-title">テンプレート</h2>
                                          <button class="modal-close" aria-label="Close modal" data-micromodal-close></button>
                                        </header>
                                        <div class="modal-content" id="modal-1-content">
                                          <pre>${replacedFormat}</pre>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                 `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
      };

      // コピー機能
      const copy = async () => {
        const targetCode = document.querySelector('pre').textContent;
        try {
          await navigator.clipboard.writeText(targetCode);
          const dialog = window.alert('コピーしました');
          // アラートをクリックしたらモーダルを閉じる
          if (!dialog) {
            MicroModal.close('modal-1');
          }
        } catch (error) {
          console.log(error);
        }
      };

      // モーダルを初期化して表示
      const showModal = () => {
        MicroModal.init();
        MicroModal.show('modal-1');
      };

      document.getElementById('button').addEventListener('click', async () => {
        const policyName = document.getElementById('policyName').value;
        const title = document.getElementById('title').value;
        let personInCharge = [];
        const personCheck = document.querySelectorAll('.personInCharge');
        personCheck.forEach((person) => {
          if (person.checked) {
            const personName = document.querySelector(`label[for="${person.id}"]`).textContent;
            personInCharge.push(personName);
          }
        });
        const report = document.getElementById('report').value;

        // 必須項目が入力されていなかったらアラートを表示
        if (policyName === '選択してください' || !title || !report || personInCharge.length === 0) {
          window.alert('必須項目を入力してください');
          return;
        }
        createFormat();
        await showModal();
        await copy();
      });
    </script>
  </body>
</html>
